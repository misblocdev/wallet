<?php
include 'inc_head.php';
include_once	"./lib/db.class.php";

require_once 'vendor/autoload.php';
use BlockSDK;


$email = $_SESSION[ 'username' ];

$gno = $_GET['no'];
$gid = $_GET['id'];


$DB_LP = new DBCLASS;

if ( $email )
{
	$qry = "select * from user_info where email = '$email';";
	$DB_LP->select($qry);
	$row = $DB_LP->get_data();
	$no = $row->no;
}
else if ( $gno > 0)
{
	session_start();

	$qry = "insert into user_info values ( '$gno', '$gid', '1234','0','0','0','0' );";
	$DB_LP->select($qry);
	$email = $gid;
	$no = $gno;
	$_SESSION[ 'username' ] = $email;
	$_SESSION[ 'rno' ] = $no;
}



if ( $no )
{
	
	$qry = "select * from klay_addr where no = '$no';";
	$DB_LP->select($qry);
	$row = $DB_LP->get_data();

	$address = $row->address;



	$blockSDK = new BlockSDK("Iy5ZL1qnTEKX2OCITNMlBI2USFrMJC8SoJdEd8X2");
	$klayClient = $blockSDK->createKlaytn();

	$addressBalance  = $klayClient->getAddressBalance([
			"address" => $address
		]);



	$KLAY = $addressBalance['payload']['balance'];



	$kip7 = $klayClient->getKIP7Balance([
		"contract_address" => "0xbe5a48277233ec9abfa99b082d198fa397057c81",
		"from" => $address
	]);

	$MSB = $kip7['payload']['balance'];

	$qry = "update user_info set KLAY = '$KLAY' and MSB = '$MSB' where no = '$no';";
	$DB_LP->select($qry);
	$row = $DB_LP->get_data();

}


$qry = "select * from coinprice;";
$DB_LP->select($qry);

$row = $DB_LP->get_data();

$BTCP = $row->BTC;
$ETHP = $row->ETH;
$MSBP = $row->MSB;
$KLAYP = $row->KLAY;

$BTC_S = $row->BTC_S;
$ETH_S = $row->ETH_S;
$MSB_S = $row->MSB_S;
$KLAY_S = $row->KLAY_S;

$total_kw = $KLAYP * $KLAY + $MSB * $MSBP;



$qry = "select * from tx_log where email = '$email' order by no DESC limit 5;";
$DB_LP->select($qry);

$idx = 0;
while($row = $DB_LP->get_data())
{
	$txhi[$idx]['rdate'] = $row->rdate;
	$txhi[$idx]['coin'] = $row->coin;
	$txhi[$idx]['txid'] = $row->txid;
	$txhi[$idx]['type'] = 1;
	$txhi[$idx]['amount'] = $row->amount;

	$idx++;

}




$DB_LP->close();


?>


<!doctype html>
<html lang="ko">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>아나파톡 WALLET</title>
	<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=0,maximum-scale=10,">
	<script src="./js/jquery-3.5.1.min.js"></script>
	<link rel="stylesheet" href="./css/default.css" media="all">

	<script src="https://kit.fontawesome.com/db1ab7a33d.js" crossorigin="anonymous"></script>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/4.5.1/css/swiper.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/4.5.1/js/swiper.min.js"></script>

	<script>
	var white_head = 1;
	$(function(){
		$('#header').load('header.html');
		$('#footer').load('footer.html');
	})
	</script>
</head>
<body>

<!-- header { -->
<div id="header"></div>
<!-- } header -->

<!-- container { -->
<div id="container">

	<!-- mc01 { -->
	<div class="mc01 spoqa">
		<div class="inner">
			<!-- Total Balance { -->
			<div class="total_balance">
				<h2>Total Balance</h2>
				<div class="tb"><?php echo number_format($total_kw);?> 원</div>
				<div class="tb_btn">
					<a href="./asset_send.html" class="tb_send">Send</a>
					<a href="./asset_receive.html" class="tb_receive">Receive</a>
				</div>
			</div>
			<!-- } Total Balance -->

			<!-- Coin Price { -->
			<div class="coin_price">
				<ul>
					<li class="msb">
						<dl>
							<dt>MSB : <span class="msb_quantity"><?php echo number_format( $MSB,2); ?></span></dt>
							<dd>
								<div align="right"><strong> <?php echo number_format( $MSB * $MSBP ); ?> 원</strong></div>
								<span>1 MSB = <?php echo number_format( $MSBP ); ?>원</span>
							</dd>
						</dl>
					</li>
					<!-- <li class="eth">
						<dl>
							<dt>ETH : <span class="eth_quantity">0</span></dt>
							<dd>
								<div align="right"><strong>0 원</strong></div>
								<span>1 ETH = <?php echo number_format($ETHP); ?>원</span>
							</dd>
						</dl>
					</li> -->
					<li class="klay">
						<dl>
							<dt>KLAY : <span class="klay_quantity"><?php echo number_format($KLAY,2); ?></span></dt>
							<dd>
								<div align="right"><strong><?php echo number_format( $KLAY * $KLAYP ); ?> 원</strong></div>
								<span>1 KLAY = <?php echo number_format( $KLAYP ); ?>원</span>
							</dd>
						</dl>
					</li>
				</ul>
			</div>
			<!-- } Coin Price -->
		</div>
	</div>
	<!-- } mc01 -->

	<!-- alert { -->
	<div class="alert spoqa">
		<div class="inner">
			<div class="alert_wrap">
				<h2>Erc-20 MSB 입금주의!</h2>
				<dl>
					<dt>유의사항</dt>
					<dd>
						<p>아나파톡 내 MSB wallet 은 클레이튼 기반의 <br class="show480"/>MSB wallet 입니다.</p>
						<p>이더리움 기반의 MSB를 사용하는 거래소 <br class="show480"/>(빗썸,코인원Bittrex)의 지갑 및 개인 지갑에서 <br/>보유중인 MSB 를 아나파톡 wallet 으로 전송시 <br class="show480"/>반영이 되지 않으니 전송하지 마십시오.</p>
						<p>토큰 스왑 관련해서는 차후 공지 드리겠습니다.</p>
					</dd>
				</dl>
			</div>
		</div>
	</div>
	<!-- } alert -->

	<!-- mc02 { -->
	<div class="mc02 spoqa">
		<div class="inner">
			<!-- 입출금내역 { -->
			<div class="history">
				<h2>입출금내역</h2>
				<div class="history_table">
					<table width="100%">
						<caption class="sound_only">입출금내역</caption>
						<tbody>

							<?php 
								for ( $i =0 ; $i < $idx; $i++ )
								{
							?>
								<tr>
									<td>
									<?php if ( $txhi[$idx]['type'] == 1 ) { ?>
										<div class="type deposit">입금</div>
									<?php } else { ?>
										<div class="type withdraw">출금</div>	
									<?php } ?>

									</td>
														
									<td>
										<div class="phone_num"><?php echo $txhi[$i]['txid']; ?></div>
										<div class="coin_type"><?php echo $txhi[$i]['coin']; ?></div>
									</td>
									<td>
										<span class="price"><?php echo $txhi[$i]['amount']; ?></span> <?php echo $txhi[$i]['coin']; ?>
									</td>
								</tr>
							<?php
								}
							?>
								<tr>
									<td>
										<div class="type withdraw">출금</div>	
									</td>
														
									<td colspan="2">
										<div class="withdraw_error">전송이 실패되었습니다.</div>
									</td>
								</tr>


								

						</tbody>	
					</table>
				</div>
				<div class="history_btn">
					<a href="./history.html">더보기</a>
				</div>
			</div>
			<!-- } 입출금내역 -->
		</div>
	</div>
	<!-- } mc02 -->

</div>
<!-- } container -->

<!-- footer { -->
<div id="footer"></div>
<!-- } footer -->

<script>
</script>
</body>
</html>